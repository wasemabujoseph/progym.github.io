<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="ŸÖÿØÿ±ÿ®ŸÉ ÿßŸÑÿ∞ŸÉŸä | Smart Trainer Pro ‚Äî ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿØÿ±Ÿäÿ®Ÿä ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ŸäÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ŸÖÿπ ŸÖŸÉÿ™ÿ®ÿ© ÿ™ŸÖÿßÿ±ŸäŸÜ ŸÉÿßŸÖŸÑÿ© Ÿàÿ™ŸàŸÑŸäÿØ ÿÆÿ∑ÿ∑ ÿπÿ®ÿ± Gemini." />
  <meta name="referrer" content="no-referrer" />
  <title>üí™ ŸÖÿØÿ±ÿ®ŸÉ ÿßŸÑÿ∞ŸÉŸä | Smart Trainer Pro</title>

  <!-- Favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üí™</text></svg>' />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" integrity="sha512-1PKOgIY59xJ6+GY2a9Y+Y1FQK6W1n1Dp1V1LhWlQ8GvZ6xjlbUY8ailqDun3vsl0sbG3fjHb4GJ8V+CsVxC1BA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      /* tweaked palette to match Amani blue */
      --bg1:#14213d; --bg2:#1d3557; --glass:rgba(255,255,255,.08); --border:rgba(255,255,255,.18);
      --text:#f1f5f9; --muted:#cbd5e1; --accent:#2d8cff; --accent2:#6ad2ff;
      --card:rgba(255,255,255,.07); --shadow:0 10px 30px rgba(0,0,0,.25);
      --chip:#2d8cff; --chip2:#10b981; --chip3:#f59e0b;
    }
    [data-theme="light"]{
      --bg1:#eef2ff; --bg2:#e2e8f0; --glass:rgba(255,255,255,.7); --border:rgba(0,0,0,.08);
      --text:#0f172a; --muted:#334155; --accent:#2563eb; --accent2:#7c3aed;
      --card:rgba(255,255,255,.9); --shadow:0 6px 18px rgba(0,0,0,.12);
      --chip:#2563eb; --chip2:#16a34a; --chip3:#d97706;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto; color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); background-attachment:fixed;
    }
    .en{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:1200px;margin:auto;padding:20px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding:16px 20px; border-radius:18px; background:var(--glass); border:1px solid var(--border); box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:10; backdrop-filter:blur(12px);
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; font-size:1.2rem}
header{backdrop-filter:saturate(1.2) blur(8px); background:linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.25)); border-bottom:1px solid var(--border)}
body.dark header{background:linear-gradient(180deg, rgba(10,12,16,.55), rgba(10,12,16,.25))}
.persona-pro{display:flex; align-items:center; gap:10px; padding:6px 12px; border-radius:999px; background:linear-gradient(135deg,var(--chip),var(--chip2)); color:#00111a; border:1px solid var(--border); box-shadow:0 1px 2px rgba(0,0,0,.08); filter:saturate(.95)}
.persona-pro .avatar{width:22px; height:22px; border-radius:999px; display:grid; place-items:center; font-weight:800; font-size:.8rem; background:#ffffff80; border:1px solid #00000020}
.persona-pro .p-text{font-weight:700; font-size:.9rem}
.btn{border-radius:12px; padding:10px 14px; border:1px solid var(--border); box-shadow:0 1px 2px rgba(0,0,0,.05); transition:.2s transform, .2s box-shadow}
.btn:hover{transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.10)}
.card{border-radius:16px; box-shadow:0 2px 14px rgba(0,0,0,.08); border:1px solid var(--border); overflow:hidden; transition:.2s transform, .2s box-shadow}
.card:hover{transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.12)}
.media{position:relative; background:#000; aspect-ratio:16/9}
.media .provider{position:absolute; top:10px; left:10px; padding:4px 8px; border-radius:999px; background:rgba(0,0,0,.55); color:#fff; font-size:.72rem}

.persona{font-size:.88rem; font-weight:700; padding:4px 10px; border-radius:999px; background:linear-gradient(135deg,var(--chip),var(--chip2)); color:#00111a; border:1px solid var(--border);}
    .brand .logo{
      width:36px;height:36px;display:grid;place-items:center;background:var(--card);border-radius:12px;
      box-shadow:0 6px 20px rgba(45,140,255,.35) inset;
    }
    .brand .logo svg{width:22px;height:22px;display:block;color:var(--accent)}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
      background:var(--card); border:1px solid var(--border); cursor:pointer; box-shadow:var(--shadow);
      transition:.2s transform,.2s opacity,.2s background; text-decoration:none; color:inherit; font-weight:600;
    }
    .btn:hover{transform:translateY(-2px)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#00111a}
    .tabs{display:flex; gap:10px; margin:18px 0 10px}
    .tab{padding:10px 14px; border-radius:12px; background:var(--card); border:1px solid var(--border); cursor:pointer; font-weight:700}
    .tab.active{outline:2px solid var(--accent)}
    .panel{display:none}
    .panel.active{display:block}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px}
    .card{background:var(--glass); border:1px solid var(--border); border-radius:18px; overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column}
    .media{position:relative; background:rgba(0,0,0,.15); aspect-ratio:4/3; display:block; overflow:hidden}
    .media .provider{position:absolute;left:8px;top:8px;background:rgba(0,0,0,.6);color:#fff;font-size:.72rem;padding:2px 6px;border-radius:8px}
    .media button.edit{position:absolute;right:8px;top:8px;background:rgba(255,255,255,.9);border:0;border-radius:999px;padding:6px;cursor:pointer}
    .media button.edit:hover{background:#ffd166}
    .media .overlay{
      position:absolute; left:8px; bottom:8px;
      display:flex; flex-direction:column; gap:4px;
      background:linear-gradient(135deg, rgba(0,0,0,.65), rgba(0,0,0,.35));
      border:1px solid var(--border);
      border-radius:10px; padding:6px 8px;
      backdrop-filter: blur(6px);
      color:#fff; max-width:90%;
      box-shadow: var(--shadow);
    }
    .media .overlay .name{ font-weight:800; font-size:.95rem; line-height:1.2 }
    .media .overlay .muscle{ font-size:.8rem; opacity:.9 }
    .media img,.media video,.media iframe{width:100%;height:100%;object-fit:cover;display:block;border:0; border-radius:0}
    .content{padding:12px 14px; display:flex; flex-direction:column; gap:8px}
    .title{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .badges{display:flex; gap:6px; flex-wrap:wrap}
    .badge{font-size:.72rem; padding:4px 8px; border-radius:999px; background:var(--card); border:1px solid var(--border)}
    .badge.best{background:linear-gradient(135deg,var(--chip),var(--chip2)); color:#00111a}
    .badge.home{background:linear-gradient(135deg,var(--chip2),var(--chip3)); color:#00111a}
    .meta{font-size:.9rem; color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .actions .btn{padding:8px 10px; font-size:.9rem}
    .searchbar{display:flex; gap:8px; margin:10px 0}
    .searchbar input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:inherit}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px}
    .chip{padding:8px 12px; border-radius:999px; background:var(--card); border:1px solid var(--border); cursor:pointer}
    .chip.active{outline:2px solid var(--accent)}
    .fieldset{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin:12px 0}
    .field{display:flex; flex-direction:column; gap:6px}
    .field input,.field select, textarea{
      padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:inherit;
    }
    .plan{white-space:pre-wrap; background:var(--glass); border:1px solid var(--border); border-radius:16px; padding:14px; line-height:1.8}
    footer{opacity:.8; font-size:.9rem; margin:16px 0; text-align:center}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
    .fadeIn{animation:fadeIn .35s ease both}
    @media print{
      header,.tabs,.chips,.searchbar,.actions-toolbar,.controls,.api-key{display:none!important}
      body{background:#fff}
      .card{break-inside:avoid}
    }
  </style>
</head>
<body data-persona='Amani'>
  <div class="container">
    <header class="fadeIn">
      <div class="brand">
        <!-- Amani kettlebell-A logo (inline SVG) -->
        <div class="logo" aria-label="Amani logo">
          <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" fill="currentColor" role="img" aria-hidden="true">
            <path d="M35 20 h50 a15 15 0 0 1 15 15 v6 a15 15 0 0 1 -15 15 h-50 a15 15 0 0 1 -15 -15 v-6 a15 15 0 0 1 15 -15 z"/>
            <path d="M20 95 L44 50 H76 L100 95 Q101 100 95 100 H79 Q76 100 75 98 L66 82 H54 L45 98 Q44 100 41 100 H25 Q19 100 20 95 Z
                     M57 63 L63 73 H51 L57 63 Z"/>
          </svg>
        </div>
        <div>ŸÖÿØÿ±ÿ®ŸÉ ÿßŸÑÿ∞ŸÉŸä <span class="en">| Smart Trainer Pro</span></div>
        <div class="persona">ŸÖÿµŸÖŸÖ ÿÆÿµŸäÿµŸãÿß ŸÑŸÄ ÿ£ŸÖÿßŸÜŸä <span class="en">| Custom-made for Amani</span></div>
      </div>
      <div class="controls">
        <button class="btn" id="langBtn"><i class="fa-solid fa-language"></i><span data-i18n="lang">English</span></button>
        <button class="btn" id="themeBtn"><i class="fa-solid fa-circle-half-stroke"></i><span data-i18n="theme">Ÿàÿ∂ÿπ ŸÅÿßÿ™ÿ≠</span></button>
        <button class="btn" id="installBtn" style="display:none"><i class="fa-solid fa-download"></i><span data-i18n="install">ÿ™ÿ´ÿ®Ÿäÿ™ PWA</span></button>
        <button class="btn" onclick="window.print()"><i class="fa-solid fa-print"></i><span data-i18n="print">ÿ∑ÿ®ÿßÿπÿ©</span></button>
      </div>
    </header>

    <!-- API Key -->
    <div class="api-key fadeIn" style="margin:14px 0; background:var(--glass); border:1px solid var(--border); padding:10px 12px; border-radius:14px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <i class="fa-solid fa-key"></i>
      <input id="apiKey" type="password" placeholder="Gemini API Key" style="flex:1; min-width:220px" />
      <button class="btn" id="saveKey"><i class="fa-regular fa-floppy-disk"></i><span data-i18n="saveKey">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠</span></button>
      <small class="meta" data-i18n="keyHint">ŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ. Ÿäÿ™ŸÖ ÿ™ÿÆÿ≤ŸäŸÜŸá ŸÖÿ≠ŸÑŸäŸãÿß ŸÅŸÇÿ∑.</small>
    </div>

    <!-- Tabs -->
    <div class="tabs actions-toolbar">
      <button class="tab active" data-tab="library" data-i18n="tabLibrary">ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ</button>
      <button class="tab" data-tab="planner" data-i18n="tabPlanner">ŸÖŸèÿÆÿ∑ŸêŸëÿ∑ ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ (ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä)</button>
      <button class="tab" data-tab="plans" data-i18n="tabMyPlans">ÿÆÿ∑ÿ∑Ÿä ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©</button>
    </div>

    <!-- Library Panel -->
    <section id="panel-library" class="panel active fadeIn">
      <div class="searchbar">
        <input id="search" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßÿ≥ŸÖ ÿßŸÑÿ™ŸÖÿ±ŸäŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ£Ÿà ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©‚Ä¶" />
        <button class="btn" id="clearSearch"><i class="fa-solid fa-xmark"></i><span data-i18n="clear">ŸÖÿ≥ÿ≠</span></button>
      </div>
      <div class="chips" id="groupChips"></div>
      <div class="grid" id="exerciseGrid"></div>
    </section>

    <!-- Planner Panel -->
    <section id="panel-planner" class="panel fadeIn">
      <div class="fieldset">
        <div class="field">
          <label data-i18n="goal">ÿßŸÑŸáÿØŸÅ</label>
          <select id="goal">
            <option value="hypertrophy" selected>ÿ®ŸÜÿßÿ° ÿßŸÑÿπÿ∂ŸÑÿßÿ™</option>
            <option value="fatloss">ÿ≠ÿ±ŸÇ ÿßŸÑÿØŸáŸàŸÜ</option>
            <option value="strength">ÿßŸÑŸÇŸàÿ©</option>
            <option value="endurance">ÿßŸÑÿ™Ÿëÿ≠ŸÖŸëŸÑ</option>
            <option value="focus">ÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ŸÖŸÜÿ∑ŸÇÿ©</option>
          </select>
        </div>
        <div class="field">
          <label data-i18n="equipment">ÿßŸÑŸÖÿπÿØÿßÿ™</label>
          <select id="equipment" multiple size="5">
            <option value="gym" selected>ÿ¨ŸäŸÖ ŸÉÿßŸÖŸÑ</option>
            <option value="dumbbells">ÿØŸÖÿ®ŸÑÿ≤</option>
            <option value="bands">ŸÖÿ∑ÿßÿ∑/ÿ±ÿ®ÿßÿ∑</option>
            <option value="bodyweight">Ÿàÿ≤ŸÜ ÿßŸÑÿ¨ÿ≥ŸÖ</option>
            <option value="kettlebell">ŸÉÿßÿ™ŸÑ ÿ®ŸäŸÑ</option>
          </select>
          <small class="meta" data-i18n="equipHint">ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ÿÆŸäÿßÿ± (Ctrl/‚åò)</small>
        </div>
        <div class="field">
          <label data-i18n="days">ÿßŸÑÿ£ŸäÿßŸÖ/ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</label>
          <select id="days">
            <option>3</option>
            <option selected>4</option>
            <option>5</option>
            <option>6</option>
          </select>
        </div>
        <div class="field">
          <label data-i18n="level">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</label>
          <select id="level">
            <option>ŸÖÿ®ÿ™ÿØÿ¶</option>
            <option selected>ŸÖÿ™Ÿàÿ≥ÿ∑</option>
            <option>ŸÖÿ™ŸÇÿØŸÖ</option>
          </select>
        </div>
        <div class="field">
          <label data-i18n="focusArea">ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
          <input id="focusArea" placeholder="ŸÖÿ´ÿßŸÑ: ÿµÿØÿ±ÿå ÿ∏Ÿáÿ±ÿå ÿ£ÿ±ÿØÿßŸÅ‚Ä¶" />
        </div>
      </div>
      <div class="actions" style="margin:8px 0 14px">
        <button class="btn primary" id="genGemini"><i class="fa-solid fa-wand-magic-sparkles"></i><span data-i18n="genGemini">ÿ™ŸàŸÑŸäÿØ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© Gemini</span></button>
        <button class="btn" id="genLocal"><i class="fa-solid fa-bolt"></i><span data-i18n="genLocal">ÿ™ŸàŸÑŸäÿØ ŸÖÿ≠ŸÑŸä (ÿ®ÿØŸàŸÜ ŸÖŸÅÿ™ÿßÿ≠)</span></button>
        <button class="btn" id="savePlan"><i class="fa-regular fa-bookmark"></i><span data-i18n="savePlan">ÿ≠ŸÅÿ∏ ÿßŸÑÿÆÿ∑ÿ©</span></button>
      </div>
      <div class="plan" id="planOutput" aria-live="polite"></div>
    </section>

    <!-- My Plans Panel -->
    <section id="panel-plans" class="panel fadeIn">
      <div id="plansList" class="grid"></div>
    </section>

    <footer>
      <div>¬© <span id="year"></span> ŸÖÿØÿ±ÿ®ŸÉ ÿßŸÑÿ∞ŸÉŸä ‚Äî <span class="en">Smart Trainer Pro</span>. <span data-i18n="foot">ÿ™ÿ∑ÿ®ŸäŸÇ ŸàŸäÿ® ÿ™ŸÇÿØŸÖŸä ŸäÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ.</span></div>
    </footer>
  </div>

  <script>
    /* ---------------- I18N ---------------- */
    const STR = {
      ar:{lang:'English', theme:'Ÿàÿ∂ÿπ ŸÅÿßÿ™ÿ≠', install:'ÿ™ÿ´ÿ®Ÿäÿ™ PWA', print:'ÿ∑ÿ®ÿßÿπÿ©',
          tabLibrary:'ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ', tabPlanner:'ŸÖŸèÿÆÿ∑ŸêŸëÿ∑ ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ (ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä)', tabMyPlans:'ÿÆÿ∑ÿ∑Ÿä ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©',
          clear:'ŸÖÿ≥ÿ≠', goal:'ÿßŸÑŸáÿØŸÅ', equipment:'ÿßŸÑŸÖÿπÿØÿßÿ™', equipHint:'ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ÿÆŸäÿßÿ± (Ctrl/‚åò)', days:'ÿßŸÑÿ£ŸäÿßŸÖ/ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ', level:'ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ',
          focusArea:'ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)', genGemini:'ÿ™ŸàŸÑŸäÿØ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© Gemini', genLocal:'ÿ™ŸàŸÑŸäÿØ ŸÖÿ≠ŸÑŸä (ÿ®ÿØŸàŸÜ ŸÖŸÅÿ™ÿßÿ≠)', savePlan:'ÿ≠ŸÅÿ∏ ÿßŸÑÿÆÿ∑ÿ©',
          foot:'ÿ™ÿ∑ÿ®ŸäŸÇ ŸàŸäÿ® ÿ™ŸÇÿØŸÖŸä ŸäÿπŸÖŸÑ ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ. ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑ ÿ™Ÿèÿ≠ŸÖŸëŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ŸÖŸÜ ŸÖÿµÿßÿØÿ± ŸÖÿ™ÿπÿØÿØÿ©.', saveKey:'ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠', keyHint:'ŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ. Ÿäÿ™ŸÖ ÿ™ÿÆÿ≤ŸäŸÜŸá ŸÖÿ≠ŸÑŸäŸãÿß ŸÅŸÇÿ∑.'},
      en:{lang:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', theme:'Light Mode', install:'Install PWA', print:'Print',
          tabLibrary:'Exercise Library', tabPlanner:'AI Workout Planner', tabMyPlans:'My Plans',
          clear:'Clear', goal:'Goal', equipment:'Equipment', equipHint:'You can select multiple (Ctrl/‚åò)', days:'Days/Week', level:'Experience',
          focusArea:'Focus Area (optional)', genGemini:'Generate with Gemini', genLocal:'Generate Locally (No Key)', savePlan:'Save Plan',
          foot:'Progressive Web App. Media loads from multiple sources.', saveKey:'Save Key', keyHint:'Key is stored locally only.'}
    };
    let LANG = localStorage.getItem('lang') || 'ar';
    function applyLang(){
      const dict = STR[LANG];
      document.documentElement.lang = LANG === 'ar' ? 'ar' : 'en';
      document.documentElement.dir = LANG === 'ar' ? 'rtl' : 'ltr';
      document.body.classList.toggle('en', LANG==='en');
      document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = dict[el.dataset.i18n] || el.textContent; });
      const s = document.getElementById('search'); if(s) s.placeholder = LANG==='ar'? 'ÿßÿ®ÿ≠ÿ´ ÿ®ÿßÿ≥ŸÖ ÿßŸÑÿ™ŸÖÿ±ŸäŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ£Ÿà ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©‚Ä¶':'Search exercises in Arabic or English‚Ä¶';
      renderGroupChips(); renderExercises();
    }

    /* ---------------- Media system ---------------- */
    const MEDIA_OVERRIDES_KEY = 'media_overrides_v1';
    const mediaOverrides = JSON.parse(localStorage.getItem(MEDIA_OVERRIDES_KEY)||'{}');
    const exerciseCache = {};

    function slugName(name){
      return name.replace(/\((.*?)\)/g,'').replace(/[^A-Za-z0-9 ]+/g,' ').trim().replace(/\s+/g,'-').replace(/-+/g,'-');
    }
    function ytSearchUrl(name){
      return `https://www.youtube.com/results?search_query=${encodeURIComponent(name+' form tutorial '+(LANG==='ar'?'ar':'en'))}`;
    }
    function ytSearchEmbedUrl(name){
      const q = name + ' exercise form ' + (LANG==='ar'?'arabic':'english');
      return `https://www.youtube-nocookie.com/embed?rel=0&modestbranding=1&playsinline=1&listType=search&list=${encodeURIComponent(q)}`;
    }
    async function getFromExerciseDB(name){
      try{
        const r = await fetch(`https://exercisedb.dev/api/v1/exercises/search?q=${encodeURIComponent(name)}&limit=1`, {mode:'cors'});
        if(!r.ok) return null; const j = await r.json(); return j?.data?.[0]?.gifUrl || null;
      }catch{ return null; }
    }
    function fpCandidates(name){
      const base='https://fitnessprogramer.com/wp-content/uploads/';
      const s = slugName(name);
      const c = [`2021/02/${s}.gif`,`2022/02/${s}.gif`,`2021/05/${s}.gif`].map(p=>base+p);
      const prox = c.map(u=> 'https://images.weserv.nl/?url='+encodeURIComponent(u.replace(/^https?:\/\//,'')));
      return [...c, ...prox];
    }
    async function resolveMedia(name){
      const key=name.toLowerCase(); if(exerciseCache[key]) return exerciseCache[key];

      if(mediaOverrides[key]){
        const url=mediaOverrides[key];
        exerciseCache[key]={kind:/\.(mp4|webm)(\?|$)/i.test(url)?'video':'image', url, provider:'Custom'};
        return exerciseCache[key];
      }

      const exdb=await getFromExerciseDB(name);
      if(exdb){ exerciseCache[key]={kind:'image', url:exdb, provider:'ExerciseDB'}; return exerciseCache[key]; }

      const fps=fpCandidates(name);
      if(fps.length){ exerciseCache[key]={kind:'image', url:fps[0], provider:'FitnessProgramer (guess)', fallbackList:fps.slice(1)}; return exerciseCache[key]; }

      exerciseCache[key]={kind:'yt', url:ytSearchEmbedUrl(name), provider:'YouTube'};
      return exerciseCache[key];
    }
    function editMedia(name, onSaved){
      const key=name.toLowerCase(); const cur=mediaOverrides[key]||'';
      const msg = LANG==='ar'?'ÿ£ŸÑÿµŸÇ ÿ±ÿßÿ®ÿ∑ GIF/MP4 ŸÑŸáÿ∞ÿß ÿßŸÑÿ™ŸÖÿ±ŸäŸÜ:':'Paste GIF/MP4 URL for this exercise:';
      const u = prompt(msg, cur);
      if(u!==null){ const v=u.trim(); if(v) mediaOverrides[key]=v; else delete mediaOverrides[key]; localStorage.setItem(MEDIA_OVERRIDES_KEY, JSON.stringify(mediaOverrides)); onSaved&&onSaved(); }
    }
    function mountYTEmbed(container, name){
  container.innerHTML='';

  // Header UI
  const prov=document.createElement('div'); prov.className='provider'; prov.textContent='YouTube';
  const bar=document.createElement('div'); bar.style.display='flex'; bar.style.gap='8px'; bar.style.alignItems='center';
  bar.appendChild(prov);

  const setBtn=document.createElement('button'); 
  setBtn.className='edit'; 
  setBtn.title=LANG==='ar'?'ÿ™ÿ≠ÿØŸäÿØ ŸÅŸäÿØŸäŸà ŸäŸàÿ™ŸäŸàÿ® ŸÖÿ®ÿßÿ¥ÿ±ÿ©':'Set direct YouTube video';
  setBtn.textContent='üé¨';
  setBtn.onclick=()=>{
    const prev = localStorage.getItem(`yt:videoId:${name}`) || (window.YT_VIDEO_IDS && window.YT_VIDEO_IDS[name]) || '';
    const val = prompt(LANG==='ar'?'ÿ£ŸÑÿµŸÇ ÿ±ÿßÿ®ÿ∑/ŸÖÿπÿ±ŸëŸÅ YouTube':'Paste YouTube URL/ID', prev||'');
    if(!val) return;
    const id = extractYouTubeId(val);
    if(id){
      localStorage.setItem(`yt:videoId:${name}`, id);
      mountMedia(container, name);
    }else{
      alert(LANG==='ar'?'ÿ™ÿπÿ∞Ÿëÿ± ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÖÿπÿ±ŸÅ ŸÖŸÜ ÿßŸÑÿ•ÿØÿÆÿßŸÑ.':'Could not extract a video ID from your input.');
    }
  };
  bar.appendChild(setBtn);

  const edit=document.createElement('button'); 
  edit.className='edit'; 
  edit.title=LANG==='ar'?'ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑':'Override media';
  edit.innerHTML='‚öôÔ∏è'; 
  edit.onclick=()=>editMedia(name,()=>mountMedia(container,name)); 
  bar.appendChild(edit);
  container.appendChild(bar);

  // Determine the best videoId to embed
  const directId = (window.YT_VIDEO_IDS && window.YT_VIDEO_IDS[name]) || localStorage.getItem(`yt:videoId:${name}`);

  function extractYouTubeId(input){
    if(!input) return null;
    const str = String(input).trim();
    // plain 11-char ID
    const idMatch = str.match(/^[a-zA-Z0-9_-]{11}$/);
    if(idMatch) return idMatch[0];
    // common URL patterns
    const patterns = [
      /[?&]v=([a-zA-Z0-9_-]{11})/,               // watch?v=
      /youtu\.be\/([a-zA-Z0-9_-]{11})/,           // youtu.be/<id>
      /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/, // embed/<id>
      /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/ // shorts/<id>
    ];
    for(const p of patterns){
      const m = str.match(p);
      if(m) return m[1];
    }
    return null;
  }

  function youtubeEmbedSrcFromId(id){
    const origin = encodeURIComponent(location.origin);
    return `https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1&origin=${origin}`;
  }

  const frame = document.createElement('iframe');
  frame.loading='lazy';
  frame.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
  frame.referrerPolicy='origin';
  frame.style.width='100%';
  frame.style.height='100%';
  container.appendChild(frame);

  // If a direct ID is available, use it immediately (no search/fallback)
  const directResolved = extractYouTubeId(directId);
  if(directResolved){
    frame.src = youtubeEmbedSrcFromId(directResolved);
    return;
  }

  // Otherwise, best-effort search based on the exercise name
  const q = name + ' exercise form ' + (LANG==='ar'?'arabic':'english');

  async function fetchFirstYoutubeId(query){
    const enc = encodeURIComponent(query);
    // 1) Piped
    try{
      const r = await fetch(`https://piped.video/api/v1/search?q=${enc}&region=US`, {mode:'cors'});
      if(r.ok){
        const j = await r.json();
        const vid = (j?.items||[]).find(x=>x.type==='video')?.id || null;
        if(vid && typeof vid === 'string' && vid.length<=15) return vid;
      }
    }catch{}
    // 2) Invidious
    try{
      const r = await fetch(`https://yewtu.be/api/v1/search?q=${enc}&type=video`, {mode:'cors'});
      if(r.ok){
        const j = await r.json();
        const vid = (Array.isArray(j) && j.length) ? (j[0].videoId || null) : null;
        if(vid && typeof vid === 'string' && vid.length<=15) return vid;
      }
    }catch{}
    // 3) HTML proxy
    try{
      const r = await fetch(`https://r.jina.ai/http://www.youtube.com/results?search_query=${enc}`, {mode:'cors'});
      if(r.ok){
        const t = await r.text();
        const m = t.match(/watch\\?v=([a-zA-Z0-9_-]{11})/);
        if(m) return m[1];
      }
    }catch{}
    return null;
  }

  (async ()=>{
    try{
      const id = await fetchFirstYoutubeId(q);
      if(id){ frame.src = youtubeEmbedSrcFromId(id); return; }
    }catch{}
    // Fallback: clickable search link
    frame.remove();
    const link = document.createElement('a');
    link.href = `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
    link.target = '_blank'; link.rel='noopener';
    link.style.display='grid'; link.style.placeItems='center'; link.style.height='100%'; link.style.textDecoration='none';
    link.textContent = LANG==='ar' ? 'ŸÅÿ™ÿ≠ ŸÜÿ™ÿßÿ¶ÿ¨ ŸäŸàÿ™ŸäŸàÿ® ŸÅŸä ÿ™ÿ®ŸàŸäÿ®' : 'Open YouTube results';
    container.appendChild(link);
  })();
}

  async function mountMedia(container, name){
      container.innerHTML='';
      const prov=document.createElement('div'); prov.className='provider'; prov.textContent='‚Ä¶'; container.appendChild(prov);
      const edit=document.createElement('button'); edit.className='edit'; edit.title= LANG==='ar'?'ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸàÿ≥ÿßÿ¶ÿ∑':'Override media'; edit.innerHTML='‚öôÔ∏è'; edit.onclick=()=>editMedia(name,()=>mountMedia(container,name)); container.appendChild(edit);

      const info = await resolveMedia(name);
      prov.textContent = info.provider;

      
      if(info.kind==='video'){
        const v=document.createElement('video');
        v.controls=true;
        v.muted=true;            // allow autoplay on most browsers
        v.autoplay=true;
        v.loop=true;
        v.playsInline=true;
        v.setAttribute('playsinline','');
        v.preload='metadata';
        v.referrerPolicy='no-referrer';
        v.loading='lazy';
        v.src=info.url;
        v.onerror=()=>mountYTEmbed(container,name);
        container.appendChild(v);
        return;
      }
      if(info.kind==='yt'){ mountYTEmbed(container,name); return; }

      const img=document.createElement('img'); img.referrerPolicy='no-referrer'; img.loading='lazy';
      const list=[info.url,...(info.fallbackList||[])]; let i=0;
      img.onerror=()=>{ i++; if(i<list.length){ img.src=list[i]; try{prov.textContent=new URL(list[i].split('?')[0]).hostname.replace('www.','');}catch{} } else { mountYTEmbed(container,name); } };
      img.onload = ()=>{ try{prov.textContent=new URL(list[i].split('?')[0]).hostname.replace('www.','');}catch{} };
      img.src=list[i]; container.appendChild(img);
    }

    /* -------------- Groups & Exercises (70+ items) -------------- */
    const TYPE_META = {
      compound:{ sets:'4√ó6‚Äì8', tempo:'2-1-2', rest:'120s', tip:'ÿ¥ÿØ ŸÑŸàÿ≠Ÿä ÿßŸÑŸÉÿ™ŸÅ Ÿàÿ´ÿ®Ÿëÿ™ ÿßŸÑÿ¨ÿ∞ÿπ', warn:'ÿ™ÿ¨ŸÜŸëÿ® ÿ™ŸÇŸàŸëÿ≥ ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ∏Ÿáÿ±' },
      strength:{ sets:'5√ó3‚Äì5', tempo:'2-0-2', rest:'150s', tip:'ÿßÿØŸÅÿπ ÿ®ÿßŸÑÿ£ŸÇÿØÿßŸÖ Ÿàÿ£ÿ®ŸÇŸê ÿßŸÑÿπŸÖŸàÿØ ŸÖÿ≠ÿßŸäÿØŸãÿß', warn:'ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿßŸÜÿØŸÅÿßÿπ' },
      isolation:{ sets:'3√ó10‚Äì15', tempo:'2-1-2', rest:'60‚Äì75s', tip:'ÿ™ÿ≠ŸÉŸëŸÖ ÿ®ÿßŸÑŸÖÿ¨ÿßŸÑ ÿßŸÑŸÉÿßŸÖŸÑ Ÿàÿßÿπÿµÿ± ŸÅŸä ÿßŸÑŸÇŸÖÿ©', warn:'ŸÑÿß ÿ™ÿ±ŸÅÿπ ŸÉÿ™ŸÅŸäŸÉ' }
    };
    const GROUPS = [
      {id:'chest', ar:'ÿßŸÑÿµÿØÿ±', en:'Chest'},
      {id:'back', ar:'ÿßŸÑÿ∏Ÿáÿ±', en:'Back'},
      {id:'legs', ar:'ÿßŸÑÿ£ÿ±ÿ¨ŸÑ', en:'Legs'},
      {id:'shoulders', ar:'ÿßŸÑŸÉÿ™ŸÅ', en:'Shoulders'},
      {id:'arms', ar:'ÿßŸÑÿ∞ÿ±ÿßÿπ', en:'Arms'},
      {id:'core', ar:'ÿßŸÑÿ¨ÿ∞ÿπ', en:'Core'},
      {id:'bonus', ar:'ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä', en:'Glutes & Home'}
    ];
    function groupIdFrom(ar){ return GROUPS.find(g=>g.ar===ar)?.id || 'other'; }
    function ex(groupAr, groupEn, nameAr, nameEn, type='compound', badges=['ŸÖŸáŸÖ'], sourcePath='', equip=['gym']){
      const meta = TYPE_META[type] || TYPE_META.compound;
      return {
        groupId: groupIdFrom(groupAr), groupAr, groupEn, nameAr, nameEn,
        sets: meta.sets, reps: '', tempo: meta.tempo, rest: meta.rest, type, badges,
        equip, source: sourcePath ? `https://fitnessprogramer.com/${sourcePath}` : '#'
      };
    }

    const EX = [
      /* --- Chest --- */ ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµÿØÿ± ÿ®ÿßŸÑÿ®ÿßÿ±','Barbell Bench Press','compound',['ÿßŸÑÿ£ŸÅÿ∂ŸÑ'],'exercise/bench-press/'),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ∂ÿ∫ÿ∑ ŸÖÿßÿ¶ŸÑ ÿ®ÿßŸÑÿØŸÖÿ®ŸÑ','Incline Dumbbell Press','compound',['ŸÖŸáŸÖ'],'exercise/incline-dumbbell-press/',['gym','dumbbells']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµÿØÿ± ÿ®ÿßŸÑÿ¢ŸÑÿ©','Machine Chest Press','compound',['ŸÖŸáŸÖ'],'exercise/chest-press-machine/'),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ∂ÿ∫ÿ∑ ŸÖÿßÿ¶ŸÑ ÿ®ÿßŸÑÿ®ÿßÿ±','Incline Barbell Bench Press','compound',['ŸÖŸáŸÖ'],'exercise/incline-bench-press/'),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ∂ÿ∫ÿ∑ ŸÖŸÜÿ≠ÿØÿ± ÿ®ÿßŸÑÿØŸÖÿ®ŸÑ','Decline Dumbbell Press','compound',['ŸÖŸáŸÖ'],'exercise/decline-dumbbell-bench-press/',['gym','dumbbells']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ŸÅŸÑÿßŸä ÿ®ÿßŸÑÿØŸÖÿ®ŸÑ','Dumbbell Chest Fly','isolation',['ÿπÿ≤ŸÑ'],'exercise/dumbbell-fly/',['gym','dumbbells']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ŸÅŸÑÿßŸä ŸÉÿßÿ®ŸÑ','Cable Crossover','isolation',['ÿπÿ≤ŸÑ'],'exercise/cable-crossover/'),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ∂ÿ∫ÿ∑ ÿ£ÿ±ÿ∂Ÿä ÿ®ÿßŸÑÿØŸÖÿ®ŸÑ','Dumbbell Floor Press','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['dumbbells']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑','Push-Up','compound',['ŸÖŸÜÿ≤ŸÑŸä','ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸÖÿßÿ¶ŸÑ','Incline Push-Up','compound',['ŸÖŸÜÿ≤ŸÑŸä','ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿØŸäŸÉŸÑŸäŸÜ','Decline Push-Up','compound',['ŸÖŸÜÿ≤ŸÑŸä','ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿØŸäÿ®ÿ≥ ŸÑŸÑÿµÿØÿ±','Chest Dips','compound',['ŸÖŸáŸÖ'], 'exercise/chest-dips/',['gym','bodyweight']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ÿ®ŸàŸÑŸàŸÅÿ± ÿØŸÖÿ®ŸÑ','Dumbbell Pullover','isolation',['ÿπÿ≤ŸÑ'], 'exercise/dumbbell-pullover/',['gym','dumbbells']),
      ex('ÿßŸÑÿµÿØÿ±','Chest','ŸÅŸÑÿßŸä ÿ¢ŸÑÿ©','Pec Deck Fly','isolation',['ÿπÿ≤ŸÑ'],'exercise/pec-deck/'),

      /* --- Back --- */ ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿßŸÑÿ±ŸÅÿπÿ© ÿßŸÑŸÖŸäÿ™ÿ©','Conventional Deadlift','strength',['ÿßŸÑÿ£ŸÅÿ∂ŸÑ'],'exercise/deadlift/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ≥ÿ≠ÿ® ÿ£ÿ±ÿ∂Ÿä ÿ®ÿßŸÑÿ®ÿßÿ±','Barbell Bent-Over Row','compound',['ŸÖŸáŸÖ'],'exercise/bent-over-row/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ≥ÿ≠ÿ® ÿπŸÑŸàŸä','Lat Pulldown','compound',['ŸÖŸáŸÖ'],'exercise/lat-pulldown/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿπŸÇŸÑÿ© ÿπÿ±Ÿäÿ∂ÿ©','Wide-Grip Pull-Up','compound',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight','gym']),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿπŸÇŸÑÿ© ŸÖÿπŸÉŸàÿ≥ÿ©','Chin-Up','compound',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight','gym']),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ≥ÿ≠ÿ® ÿ¨ÿßŸÑÿ≥ ŸÉÿßÿ®ŸÑ','Seated Cable Row','compound',['ŸÖŸáŸÖ'],'exercise/seated-cable-row/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','T-Bar ÿ±Ÿà','T-Bar Row','compound',['ŸÖŸáŸÖ'],'exercise/t-bar-row/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ≥ÿ≠ÿ® ÿ∞ÿ±ÿßÿπ Ÿàÿßÿ≠ÿØÿ© ÿØŸÖÿ®ŸÑ','One-Arm Dumbbell Row','compound',['ŸÖŸÜÿ≤ŸÑŸä'],'exercise/one-arm-dumbbell-row/',['gym','dumbbells']),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ≥ÿ≠ÿ® ÿ∞ÿ±ÿßÿπ ŸÖÿ≥ÿ™ŸÇŸäŸÖÿ©','Straight-Arm Pulldown','isolation',['ÿπÿ≤ŸÑ'],'exercise/straight-arm-pulldown/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ≥ÿ≠ÿ® ÿµÿØÿ± ŸÖÿØÿπŸëŸÖ','Chest-Supported Row','compound',['ŸÖŸáŸÖ'],'exercise/chest-supported-row/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ±Ÿà ŸÖÿπŸÉŸàÿ≥ÿ©','Inverted Row','compound',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight','gym']),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ¨ŸàÿØ ŸÖŸàÿ±ŸÜŸäŸÜÿ¨','Good Morning','strength',['ÿ™ŸÇŸàŸäÿ©'], 'exercise/good-morning/'),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ±Ÿà ŸÖŸäÿØŸàÿ≤','Meadows Row','compound',['ŸÖÿ™ŸÇÿØŸÖ'], '', ['gym','dumbbells']),
      ex('ÿßŸÑÿ∏Ÿáÿ±','Back','ÿ≥ÿ≠ÿ® ÿ≠ÿ®ŸÑ ŸÑŸÑŸàÿ¨Ÿá','Face Pull','isolation',['ÿπÿ≤ŸÑ'],'exercise/face-pull/'),

      /* --- Legs --- */ ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿ≥ŸÉŸàÿßÿ™ ÿ∏Ÿáÿ±','Back Squat','strength',['ÿßŸÑÿ£ŸÅÿ∂ŸÑ'],'exercise/squat/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿ≥ŸÉŸàÿßÿ™ ÿ£ŸÖÿßŸÖŸä','Front Squat','strength',['ŸÖŸáŸÖ'],'exercise/front-squat/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿ≥ŸàŸÖŸà ÿØŸäÿØ ŸÑŸÅÿ™','Sumo Deadlift','strength',['ŸÖŸáŸÖ'],'exercise/sumo-deadlift/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸÑÿßŸÜÿ¨ÿ≤ ŸÖÿ¥Ÿä','Walking Lunges','compound',['ŸÖŸáŸÖ'],'exercise/walking-lunge/',['gym','dumbbells','bodyweight']),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸÑÿßŸÜÿ¨ÿ≤ ÿ®ŸÑÿ∫ÿßÿ±Ÿä','Bulgarian Split Squat','compound',['ŸÖŸÜÿ≤ŸÑŸä'],'exercise/bulgarian-split-squat/',['gym','dumbbells','bodyweight']),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸáÿßŸÉ ÿ≥ŸÉŸàÿßÿ™','Hack Squat','strength',['ŸÖŸáŸÖ'],'exercise/hack-squat/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸÑŸäÿ¨ ÿ®ÿ±ÿ≥','Leg Press','compound',['ŸÖŸáŸÖ'],'exercise/leg-press/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿ±ŸàŸÖÿßŸÜŸäÿßŸÜ ÿØŸäÿØŸÑŸÅÿ™','Romanian Deadlift','strength',['ŸÖŸáŸÖ'],'exercise/romanian-deadlift/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿßŸÉÿ≥ÿ™ŸÜÿ¥ŸÜ ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Leg Extension','isolation',['ÿπÿ≤ŸÑ'],'exercise/leg-extension/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸÉŸäÿ±ŸÑ ŸáÿßŸÖÿ≥ÿ™ÿ±ŸÜÿ¨','Lying Leg Curl','isolation',['ÿπÿ≤ŸÑ'],'exercise/lying-leg-curl/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸÉŸäÿ±ŸÑ ŸáÿßŸÖÿ≥ÿ™ÿ±ŸÜÿ¨ ÿ¨ÿßŸÑÿ≥','Seated Leg Curl','isolation',['ÿπÿ≤ŸÑ'],'exercise/seated-leg-curl/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿ±ŸÅÿπ ÿßŸÑÿ≥ŸÖÿßŸÜÿ© ŸàÿßŸÇŸÅ','Standing Calf Raise','isolation',['ÿπÿ≤ŸÑ'],'exercise/standing-calf-raise/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿ±ŸÅÿπ ÿßŸÑÿ≥ŸÖÿßŸÜÿ© ÿ¨ÿßŸÑÿ≥','Seated Calf Raise','isolation',['ÿπÿ≤ŸÑ'],'exercise/seated-calf-raise/'),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸÜŸàÿ±ÿØŸÉ ŸÉŸäÿ±ŸÑ','Nordic Hamstring Curl','strength',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight','gym']),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ŸÇŸÅÿ≤ÿ© ÿßŸÑÿµŸÜÿØŸàŸÇ','Box Jump','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bodyweight']),
      ex('ÿßŸÑÿ£ÿ±ÿ¨ŸÑ','Legs','ÿ≥Ÿäÿ≥Ÿä ÿ≥ŸÉŸàÿßÿ™','Sissy Squat','isolation',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bodyweight','gym']),

      /* --- Shoulders --- */ ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ∂ÿ∫ÿ∑ ŸÉÿ™ŸÅ ÿ®ÿßÿ±','Barbell Overhead Press','compound',['ÿßŸÑÿ£ŸÅÿ∂ŸÑ'],'exercise/overhead-press/'),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ∂ÿ∫ÿ∑ ŸÉÿ™ŸÅ ÿØŸÖÿ®ŸÑ','Dumbbell Shoulder Press','compound',['ŸÖŸáŸÖ'],'exercise/dumbbell-shoulder-press/',['gym','dumbbells']),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ±ŸÅÿ±ŸÅÿ© ÿ¨ÿßŸÜÿ®Ÿäÿ©','Lateral Raise','isolation',['ÿπÿ≤ŸÑ'],'exercise/dumbbell-lateral-raise/',['gym','dumbbells']),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ±ŸÅÿ±ŸÅÿ© ÿÆŸÑŸÅŸäÿ©','Rear Delt Fly','isolation',['ÿπÿ≤ŸÑ'],'exercise/reverse-pec-deck/',['gym','dumbbells']),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ŸÅÿ±ŸàŸÜÿ™ ÿ±Ÿäÿ≤','Front Raise','isolation',['ÿπÿ≤ŸÑ'],'exercise/front-raise/',['gym','dumbbells']),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ£ÿ±ŸÜŸàŸÑÿØ ÿ®ÿ±ÿ≥','Arnold Press','compound',['ŸÖÿ™Ÿàÿ≥ÿ∑'],'exercise/arnold-press/',['gym','dumbbells']),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ŸÉÿßÿ®ŸÑ ÿ±ŸÅÿ±ŸÅÿ© ÿ¨ÿßŸÜÿ®Ÿäÿ©','Cable Lateral Raise','isolation',['ÿπÿ≤ŸÑ'],'exercise/cable-lateral-raise/'),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ≥ÿ≠ÿ® ŸÑŸÑŸàÿ¨Ÿá (ŸÉÿßÿ®ŸÑ)','Face Pull (Cable)','isolation',['ÿπÿ≤ŸÑ'],'exercise/face-pull/'),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ŸäŸà ÿ®ÿ±ÿßŸäÿ™ ÿ±Ÿà','Upright Row','compound',['ŸÖŸáŸÖ'],'exercise/upright-row/'),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ±ŸÅÿ±ŸÅÿ© ÿ¨ÿßŸÜÿ®Ÿäÿ© ŸàÿßŸÇŸÅ ÿ®ÿßŸÉÿ™ŸÑ ÿ®ŸäŸÑ','KB Lateral Raise','isolation',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['kettlebell']),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿØŸàÿ±ÿßŸÜ ŸÉÿ™ŸÅ ŸÉŸàÿ®Ÿä','Cuban Rotation','isolation',['ÿµÿ≠ÿ© ŸÉÿ™ŸÅ'], '', ['dumbbells','bands','gym']),
      ex('ÿßŸÑŸÉÿ™ŸÅ','Shoulders','ÿ∂ÿ∫ÿ∑ ŸÉÿ™ŸÅ ŸÉÿßÿ™ŸÑ ÿ®ŸäŸÑ','Kettlebell Press','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['kettlebell']),

      /* --- Arms --- */ ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿ®ÿßÿ±ÿ®ŸÑ ŸÉŸàÿ±ŸÑ','Barbell Curl','isolation',['ÿπÿ≤ŸÑ'],'exercise/barbell-curl/'),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ŸÉŸàÿ±ŸÑ ÿØŸÖÿ®ŸÑ ÿ™ÿ®ÿßÿØŸÑŸä','Alternating DB Curl','isolation',['ÿπÿ≤ŸÑ'],'exercise/alternating-dumbbell-curl/',['gym','dumbbells']),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ŸáÿßŸÖÿ± ŸÉŸàÿ±ŸÑ','Hammer Curl','isolation',['ÿπÿ≤ŸÑ'],'exercise/hammer-curl/',['gym','dumbbells']),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ŸÉŸàŸÜÿ≥ŸÜÿ™ÿ±ÿ¥ŸÜ ŸÉŸàÿ±ŸÑ','Concentration Curl','isolation',['ÿπÿ≤ŸÑ'],'exercise/concentration-curl/',['gym','dumbbells']),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿ≤Ÿàÿ™ŸÖŸÜ ŸÉŸàÿ±ŸÑ','Zottman Curl','isolation',['ÿπÿ≤ŸÑ'], '', ['dumbbells']),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ŸÉŸàÿ±ŸÑ ŸÉÿßÿ®ŸÑ','Cable Curl','isolation',['ÿπÿ≤ŸÑ'],'exercise/cable-curl/'),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿ≥ŸÉŸàŸÑ ŸÉÿ±ÿßÿ¥ÿ±','Skull Crushers','isolation',['ŸÖŸáŸÖ'],'exercise/skull-crusher/'),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿ∂ÿ∫ÿ∑ ÿ´ŸÑÿßÿ´Ÿä ÿ≠ÿ®ŸÑ','Rope Pushdown','isolation',['ÿπÿ≤ŸÑ'],'exercise/triceps-pushdown/'),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿ£ŸàŸÅÿ±ŸáŸäÿØ ÿßŸÉÿ≥ÿ™ŸÜÿ¥ŸÜ','Overhead Triceps Extension','isolation',['ÿπÿ≤ŸÑ'],'exercise/overhead-cable-triceps-extension/',['gym','dumbbells']),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿØŸäÿ®ÿ≥ ŸÑŸÑÿπÿ∂ÿØ ÿßŸÑÿÆŸÑŸÅŸäÿ©','Triceps Dips','compound',['ÿ¨ÿ≥ŸÖŸÉ'],'exercise/triceps-dips/',['bodyweight','gym']),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿ∂ÿ∫ÿ∑ ÿ∂ŸäŸÇ ÿ®ÿßŸÑÿ®ÿßÿ±','Close-Grip Bench Press','compound',['ŸÖŸáŸÖ'],'exercise/close-grip-bench-press/'),
      ex('ÿßŸÑÿ∞ÿ±ÿßÿπ','Arms','ÿ®ŸÜÿ¥ ÿØŸäÿ®ÿ≥','Bench Dips','compound',['ŸÖŸÜÿ≤ŸÑŸä','ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),

      /* --- Core --- */ ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ®ŸÑÿßŸÜŸÉ','Plank','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ®ŸÑÿßŸÜŸÉ ÿ¨ÿßŸÜÿ®Ÿä','Side Plank','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ŸÉÿ±ŸÜÿ¥','Crunch','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ±ŸÅÿπ ÿ£ÿ±ÿ¨ŸÑ ŸÖÿπŸÑŸëŸÇ','Hanging Leg Raise','isolation',['ŸÖŸáŸÖ'], '', ['bodyweight','gym']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ®ÿßŸäÿ≥ŸÉŸÑ ŸÉÿ±ŸÜÿ¥','Bicycle Crunch','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ±Ÿàÿ≥ŸäÿßŸÜ ÿ™ŸàŸäÿ≥ÿ™','Russian Twist','isolation',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bodyweight','dumbbells','kettlebell']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ±ŸàŸÑ ÿ¢Ÿàÿ™ Ab Wheel','Ab Wheel Rollout','isolation',['ŸÖÿ™Ÿàÿ≥ÿ∑'], '', ['gym']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿØŸäÿØ ÿ®ÿ∫','Dead Bug','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ŸáŸàŸÑŸà ŸáŸàŸÑÿØ','Hollow Hold','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ®Ÿäÿ±ÿØ ÿØŸàÿ∫','Bird Dog','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ÿ®ÿßŸÑŸàŸÅ ÿ®ÿ±ÿ≥','Pallof Press','isolation',['ÿπÿ≤ŸÑ'], '', ['bands','gym']),
      ex('ÿßŸÑÿ¨ÿ∞ÿπ','Core','ŸàŸàÿØ ÿ™ÿ¥Ÿàÿ® ŸÉÿßÿ®ŸÑ','Cable Woodchop','isolation',['ÿπÿ≤ŸÑ'],'exercise/wood-chop/'),

      /* --- Glutes & Home --- */ ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸáŸäÿ® ÿ´ÿ±ÿ≥ÿ™','Barbell Hip Thrust','compound',['ÿßŸÑÿ£ŸÅÿ∂ŸÑ'],'exercise/hip-thrust/'),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ÿ¨ŸÑŸàŸàÿ™ ÿ®ÿ±ŸäÿØÿ¨','Glute Bridge','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bodyweight','dumbbells','gym']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ÿ±ŸÅÿπÿ© ÿ±ŸàŸÖÿßŸÜŸäÿ© ÿ±ÿ¨ŸÑ Ÿàÿßÿ≠ÿØÿ©','Single-Leg RDL','isolation',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['dumbbells','kettlebell','bodyweight']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸÉŸäŸÉ ÿ®ÿßŸÉ','Glute Kickback','isolation',['ÿπÿ≤ŸÑ'], '', ['bands','gym']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸÅÿßŸäÿ± ŸáÿßŸäÿØÿ±ÿßŸÜÿ™','Fire Hydrant','isolation',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bodyweight','bands']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸÉŸÑÿßŸÖÿ¥ŸäŸÑ','Clamshell','isolation',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bands']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ÿ≥ÿ™Ÿäÿ® ÿ£ÿ®','Step-Up','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['dumbbells','bodyweight']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ÿ∫Ÿàÿ®ŸÑÿ™ ÿ≥ŸÉŸàÿßÿ™','Goblet Squat','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['dumbbells','kettlebell']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸÉÿßÿ™ŸÑ ÿ®ŸäŸÑ ÿ≥ŸàŸäŸÜÿ∫','Kettlebell Swing','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['kettlebell']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸÖÿ¥Ÿä ÿ¨ÿßŸÜÿ®Ÿä ÿ®ÿßŸÑÿ±ÿ®ÿßÿ∑','Banded Lateral Walk','isolation',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bands']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸàÿßŸÑ ÿ≥Ÿêÿ™','Wall Sit','isolation',['ÿ¨ÿ≥ŸÖŸÉ'], '', ['bodyweight']),
      ex('ÿ£ÿ±ÿØÿßŸÅ/ŸÖŸÜÿ≤ŸÑŸä','Glutes & Home','ŸÑÿßŸÜÿ¨ÿ≥ ŸÉŸäÿ±ÿ™ÿ≥Ÿä','Curtsy Lunge','compound',['ŸÖŸÜÿ≤ŸÑŸä'], '', ['bodyweight','dumbbells'])
    ];

    /* ---------------- UI State ---------------- */
    let currentGroup = 'all';
    let searchTerm = '';
    const yearEl = document.getElementById('year'); yearEl.textContent = new Date().getFullYear();

    // Group chips
    function renderGroupChips(){
      const wrap = document.getElementById('groupChips'); wrap.innerHTML='';
      const all = document.createElement('div'); all.className='chip'+(currentGroup==='all'?' active':''); all.textContent = (LANG==='ar'?'ÿßŸÑŸÉŸÑ':'All');
      all.onclick=()=>{currentGroup='all'; renderGroupChips(); renderExercises();};
      wrap.appendChild(all);
      GROUPS.forEach(g=>{
        const count = EX.filter(e=>e.groupId===g.id).length;
        const chip=document.createElement('div'); chip.className='chip'+(currentGroup===g.id?' active':'');
        chip.textContent = (LANG==='ar'? g.ar:g.en) + ` (${count})`;
        chip.onclick=()=>{currentGroup=g.id; renderGroupChips(); renderExercises();};
        wrap.appendChild(chip);
      });
    }

    // Exercise cards
    function renderExercises(){
      const grid = document.getElementById('exerciseGrid'); grid.innerHTML='';
      const q = searchTerm.trim().toLowerCase();
      let list = EX.filter(e => currentGroup==='all' || e.groupId===currentGroup);
      if(q){
        list = list.filter(e=>
          e.nameAr.toLowerCase().includes(q) ||
          e.nameEn.toLowerCase().includes(q) ||
          e.groupAr.toLowerCase().includes(q) ||
          e.groupEn.toLowerCase().includes(q)
        );
      }
      list.forEach(item=>{
        const card=document.createElement('div'); card.className='card fadeIn';

        const media=document.createElement('div'); media.className='media'; card.appendChild(media);
        mountMedia(media, item.nameEn);
        const overlay=document.createElement('div'); overlay.className='overlay';
        overlay.innerHTML = `<div class="name">${item.nameAr}<span class="en"> | ${item.nameEn}</span></div>
                             <div class="muscle">${item.groupAr}<span class="en"> | ${item.groupEn}</span></div>`;
        media.appendChild(overlay);

        const content=document.createElement('div'); content.className='content';
        const title=document.createElement('div'); title.className='title';
        title.innerHTML = `<strong>${item.nameAr}</strong> <span class="en">| ${item.nameEn}</span>`;
        content.appendChild(title);

        const badges=document.createElement('div'); badges.className='badges';
        item.badges.forEach(b=>{
          const s=document.createElement('span'); s.className='badge'+(b==='ÿßŸÑÿ£ŸÅÿ∂ŸÑ'?' best':(b==='ŸÖŸÜÿ≤ŸÑŸä'?' home':'')); s.textContent=b; badges.appendChild(s);
        });
        const t=document.createElement('span'); t.className='badge'; t.textContent = item.type==='compound'?(LANG==='ar'?'ÿ£ÿ≥ÿßÿ≥Ÿä':'Compound'): item.type==='strength'?(LANG==='ar'?'ŸÇŸàÿ©':'Strength'):(LANG==='ar'?'ÿπÿ≤ŸÑ':'Isolation');
        badges.appendChild(t);
        content.appendChild(badges);

        const meta=document.createElement('div'); meta.className='meta';
        meta.textContent = `${LANG==='ar'?'ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿßÿ™':'Sets'}: ${item.sets} ‚Ä¢ ${LANG==='ar'?'ÿßŸÑÿ™ŸÖÿ®Ÿà':'Tempo'}: ${item.tempo} ‚Ä¢ ${LANG==='ar'?'ÿ±ÿßÿ≠ÿ©':'Rest'}: ${item.rest}`;
        content.appendChild(meta);

        const actions=document.createElement('div'); actions.className='actions';
        const yt = document.createElement('a'); yt.href=ytSearchUrl(item.nameEn); yt.target='_blank'; yt.rel='noopener'; yt.className='btn'; yt.innerHTML='<i class="fa-brands fa-youtube"></i> YouTube';
        const src = document.createElement('a'); src.href=item.source||'#'; src.target='_blank'; src.rel='noopener'; src.className='btn'; src.innerHTML='<i class="fa-solid fa-book-open"></i> Source';
        actions.appendChild(yt); actions.appendChild(src);
        content.appendChild(actions);

        card.appendChild(content);
        grid.appendChild(card);
      });
    }

    // Search
    document.getElementById('search').addEventListener('input', e=>{ searchTerm=e.target.value; renderExercises(); });
    document.getElementById('clearSearch').addEventListener('click', ()=>{ document.getElementById('search').value=''; searchTerm=''; renderExercises(); });

    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+btn.dataset.tab).classList.add('active');
      });
    });

    // Theme toggle
    const THEME_KEY='stp_theme';
    function applyTheme(){
      const t=localStorage.getItem(THEME_KEY)||'dark';
      document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark');
      document.querySelector('#themeBtn span').textContent = LANG==='ar'?(t==='light'?'Ÿàÿ∂ÿπ ÿØÿßŸÉŸÜ':'Ÿàÿ∂ÿπ ŸÅÿßÿ™ÿ≠'):(t==='light'?'Dark Mode':'Light Mode');
    }
    document.getElementById('themeBtn').addEventListener('click', ()=>{
      const cur=localStorage.getItem(THEME_KEY)||'dark';
      localStorage.setItem(THEME_KEY, cur==='light'?'dark':'light'); applyTheme();
    });

    // Lang toggle
    document.getElementById('langBtn').addEventListener('click', ()=>{ LANG = (LANG==='ar'?'en':'ar'); localStorage.setItem('lang',LANG); applyLang(); });

    // API key
    const KEY_STORE='gemini_api_key';
    document.getElementById('saveKey').addEventListener('click', ()=>{
      localStorage.setItem(KEY_STORE, document.getElementById('apiKey').value.trim());
      alert(LANG==='ar'?'ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸÖÿ≠ŸÑŸäŸãÿß.':'Key saved locally.');
    });
    const savedKey = localStorage.getItem(KEY_STORE); if(savedKey) document.getElementById('apiKey').value = savedKey;

    /* -------------- Planner (AI or local) -------------- */
    function getPlannerOptions(){
      const equipment = Array.from(document.getElementById('equipment').selectedOptions).map(o=>o.value);
      return {
        goal: document.getElementById('goal').value,
        days: parseInt(document.getElementById('days').value,10),
        level: document.getElementById('level').value,
        focusArea: document.getElementById('focusArea').value.trim(),
        equipment: equipment.length? equipment : ['gym'],
        lang: LANG
      };
    }
    function buildPrompt(opts){
      const label = (LANG==='ar'
        ? `ÿ£ŸÜÿ™ ŸÖÿØÿ±Ÿëÿ® ŸÖÿ≠ÿ™ÿ±ŸÅ. ÿ£ŸÜÿ¥ÿ¶ ÿÆÿ∑ÿ© ÿ™ÿØÿ±Ÿäÿ® ŸÑŸÖÿØÿ© ${opts.days} ÿ£ŸäÿßŸÖ/ÿ£ÿ≥ÿ®Ÿàÿπ ŸÑŸáÿØŸÅ "${opts.goal}" ŸàŸÖÿ≥ÿ™ŸàŸâ "${opts.level}"` + (opts.focusArea? ` ŸÖÿπ ÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ: ${opts.focusArea}.`:'') + ` ÿßŸÑŸÖÿπÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©: ${opts.equipment.join(', ')}. ÿ£ÿπÿ∑ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸàÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©ÿå ŸÖÿ¨ŸÖŸàÿπÿßÿ™√óÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ÿå ÿ™ŸÖÿ®Ÿà Ÿàÿ±ÿßÿ≠ÿ©ÿå ŸàŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ™ŸÇŸÜŸäÿ© ŸÇÿµŸäÿ±ÿ©.`
        : `You are a pro coach. Create a ${opts.days}-day/week plan for goal "${opts.goal}" and level "${opts.level}"` + (opts.focusArea? ` with focus on: ${opts.focusArea}.`:'') + ` Available equipment: ${opts.equipment.join(', ')}. Return exercise names in Arabic & English, sets√óreps, tempo, rest, and brief technique notes.`
      );
      return label + (LANG==='ar' ? `\nÿµŸäÿ∫ÿ© ŸÖŸÜÿ∏ŸÖÿ©:\nÿßŸÑŸäŸàŸÖ 1 ‚Äî ÿßŸÑÿπŸÜŸàÿßŸÜ\n‚Ä¢ ÿ™ŸÖÿ±ŸäŸÜ ‚Äî 4√ó8‚Äì12 | ÿ™ŸÖÿ®Ÿà: 2-1-2 | ÿ±ÿßÿ≠ÿ©: 90s\n‚Ä¶` : `\nFormat:\nDay 1 ‚Äî Title\n‚Ä¢ Exercise ‚Äî 4√ó8‚Äì12 | Tempo: 2-1-2 | Rest: 90s\n‚Ä¶`);
    }
    function repRange(goal, type){
      if(goal==='strength') return (type==='isolation')?'3√ó6‚Äì8':'5√ó3‚Äì5';
      if(goal==='endurance') return '3√ó15‚Äì20';
      if(goal==='fatloss') return '3‚Äì4√ó10‚Äì15';
      if(goal==='focus') return (type==='isolation')?'3√ó12‚Äì15':'4√ó8‚Äì12';
      return (type==='isolation')?'3√ó12‚Äì15':'4√ó8‚Äì12';
    }
    function findGroupIdFromText(text){
      const t=text.toLowerCase();
      if(/ÿµÿØÿ±|chest/.test(t)) return 'chest';
      if(/ÿ∏Ÿáÿ±|back/.test(t)) return 'back';
      if(/ÿ≥ÿßŸÇ|ÿ±ÿ¨ŸÑ|legs|quads|hamstring|calf/.test(t)) return 'legs';
      if(/ŸÉÿ™ŸÅ|shoulder/.test(t)) return 'shoulders';
      if(/ÿ∞ÿ±ÿßÿπ|arm|bicep|tricep/.test(t)) return 'arms';
      if(/ÿ®ÿ∑ŸÜ|ŸÉŸàÿ±|ÿ¨ÿ∞ÿπ|abs|core/.test(t)) return 'core';
      if(/ÿ£ÿ±ÿØÿßŸÅ|glute|ŸÖŸÜÿ≤ŸÑ/.test(t)) return 'bonus';
      return null;
    }
    function pickExercises(groupIds, count, equipSet, biasId){
      let pool = EX.filter(e=> groupIds.includes(e.groupId) && e.equip.some(t=>equipSet.has(t) || equipSet.has('gym')));
      if(biasId){ const biased = pool.filter(e=>e.groupId===biasId); pool = [...biased, ...pool]; }
      const best = pool.filter(e=>e.badges.includes('ÿßŸÑÿ£ŸÅÿ∂ŸÑ'));
      const rest = pool.filter(e=>!e.badges.includes('ÿßŸÑÿ£ŸÅÿ∂ŸÑ'));
      const chosen=[];
      function take(arr){ while(arr.length && chosen.length<count){ const i=Math.floor(Math.random()*arr.length); chosen.push(arr.splice(i,1)[0]); } }
      take(best); take(rest);
      return chosen.slice(0,count);
    }
    function dayTitle(id){ const d=id+1; return LANG==='ar' ? `ÿßŸÑŸäŸàŸÖ ${d}` : `Day ${d}`; }
    function buildLocalPlan(opts){
      const eq = new Set(opts.equipment);
      const bias = findGroupIdFromText(opts.focusArea||'');
      const blocks = [];
      let split;

      if(opts.days===3){ split = ['push','pull','legs']; }
      else if(opts.days===4){ split = ['upper','lower','upper','lower']; }
      else if(opts.days===5){ split = ['upper','lower','push','pull','full']; }
      else { split = ['push','pull','legs','push','pull','legs']; }

      split.forEach((type, i)=>{
        let groups, title;
        if(type==='push'){ groups=['chest','shoulders','arms']; title = LANG==='ar'?'ÿØŸÅÿπ (ÿµÿØÿ±/ŸÉÿ™ŸÅ/ÿ™ÿ±ÿßŸä)':'Push (Chest/Shoulders/Triceps)'; }
        else if(type==='pull'){ groups=['back','shoulders','arms']; title = LANG==='ar'?'ÿ≥ÿ≠ÿ® (ÿ∏Ÿáÿ±/ÿ®ÿßŸäÿ≥ÿ®ÿ≥)':'Pull (Back/Biceps)'; }
        else if(type==='legs'){ groups=['legs','bonus','core']; title = LANG==='ar'?'ÿ£ÿ±ÿ¨ŸÑ Ÿàÿ£ÿ±ÿØÿßŸÅ':'Legs & Glutes'; }
        else if(type==='upper'){ groups=['chest','back','shoulders','arms']; title = LANG==='ar'?'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿπŸÑŸàŸä':'Upper'; }
        else if(type==='lower'){ groups=['legs','bonus','core']; title = LANG==='ar'?'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ≥ŸÅŸÑŸä':'Lower'; }
        else { groups=['chest','back','legs','shoulders','arms','core']; title = LANG==='ar'?'ŸÅŸÑ ÿ®ŸàÿØŸä':'Full Body'; }

        const main = pickExercises(groups, 5, eq, bias);
        const lines = [];
        lines.push((LANG==='ar'?`‚Äî ${title}`:`‚Äî ${title}`));
        main.forEach(exe=>{
          const r = repRange(opts.goal, exe.type);
          const tempo = exe.tempo;
          const rest = exe.rest;
          const name = `${exe.nameAr} | ${exe.nameEn}`;
          lines.push(`‚Ä¢ ${name} ‚Äî ${r} | ${LANG==='ar'?'ÿ™ŸÖÿ®Ÿà':'Tempo'}: ${tempo} | ${LANG==='ar'?'ÿ±ÿßÿ≠ÿ©':'Rest'}: ${rest}`);
        });
        if(!groups.includes('core')){
          const corePick = pickExercises(['core'], 1, eq, bias)[0];
          if(corePick){
            lines.push(`‚Ä¢ ${LANG==='ar'?'ŸÖŸÜŸáŸäŸëÿ© ŸÉŸàÿ±':'Core Finisher'}: ${corePick.nameAr} | ${corePick.nameEn} ‚Äî ${repRange(opts.goal, corePick.type)}`);
          }
        }
        blocks.push(`${dayTitle(i)} ${lines.join('\n')}`);
      });

      const head = (LANG==='ar'
        ? `ÿÆÿ∑ÿ© ÿ™ÿØÿ±Ÿäÿ® (${opts.days} ÿ£ŸäÿßŸÖ/ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ) ‚Äî ÿßŸÑŸáÿØŸÅ: ${opts.goal}${opts.focusArea?` ‚Äî ÿ™ÿ±ŸÉŸäÿ≤: ${opts.focusArea}`:''}\nÿßŸÑŸÖÿπÿØÿßÿ™: ${opts.equipment.join('ÿå ')}\n`
        : `Training Plan (${opts.days} days/week) ‚Äî Goal: ${opts.goal}${opts.focusArea?` ‚Äî Focus: ${opts.focusArea}`:''}\nEquipment: ${opts.equipment.join(', ')}\n`
      );
      const notes = (LANG==='ar'
        ? `\nŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:\n‚Ä¢ ÿßÿ®ÿØÿ£ ÿ•ÿ≠ŸÖÿßÿ° ÿπÿßŸÖ 5‚Äì10 ÿØŸÇÿßÿ¶ŸÇ + ÿ•ÿ≠ŸÖÿßÿ° ÿÆÿßÿµ ŸÑŸÑÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑÿ£ŸàŸÑ.\n‚Ä¢ ÿ≤ŸêÿØ ÿßŸÑÿ£ÿ≠ŸÖÿßŸÑ ÿ™ÿØÿ±Ÿäÿ¨ŸäŸãÿß ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ™ŸÇŸÜŸäÿ©.\n‚Ä¢ ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿ™ŸÇÿØŸëŸÖ ÿ£ÿ≥ÿ®ŸàÿπŸäŸãÿß.`
        : `\nNotes:\n‚Ä¢ Begin with 5‚Äì10 min general warm-up + ramp-up sets.\n‚Ä¢ Progressive overload with clean form.\n‚Ä¢ Log progress weekly.`
      );
      return head + blocks.join('\n\n') + notes;
    }

    const planOut = document.getElementById('planOutput');

    document.getElementById('genLocal').addEventListener('click', ()=>{
      const opts = getPlannerOptions();
      planOut.textContent = LANG==='ar'?'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸàŸÑŸäÿØ ŸÖÿ≠ŸÑŸäŸãÿß‚Ä¶':'Generating locally‚Ä¶';
      setTimeout(()=>{ planOut.textContent = buildLocalPlan(opts); }, 50);
    });

    document.getElementById('genGemini').addEventListener('click', async ()=>{
      const opts = getPlannerOptions();
      const apiKey = (document.getElementById('apiKey').value||'').trim();
      const prompt = buildPrompt(opts);

      if(!window.AI || typeof window.AI.generatePlan!=='function'){
        planOut.textContent = (LANG==='ar'
          ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅ ai.js. ÿ£ÿ∂ŸÅ ŸÖŸÑŸÅŸãÿß ÿ®ÿßÿ≥ŸÖ "ai.js" ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ¨ŸÑÿØ ŸÑÿ™ÿπÿ±ŸäŸÅ window.AI.generatePlan(). ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÇÿßŸÑÿ® ÿßŸÑŸÖÿ±ŸÅŸÇ ŸÅŸä ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™.'
          : 'ai.js not found. Add a local "ai.js" next to this file that defines window.AI.generatePlan(). Use the template provided below.');
        return;
      }
      if(!apiKey){
        planOut.textContent = LANG==='ar'?'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖŸÅÿ™ÿßÿ≠ API (ÿ£Ÿà ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÖÿ≠ŸÑŸä).':'Please enter an Gemini API key (or use local generation).';
        return;
      }
      planOut.textContent = LANG==='ar'?'Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàŸÑŸäÿØ ÿπÿ®ÿ± ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä‚Ä¶':'Generating via AI‚Ä¶';
      try{
        const text = await window.AI.generatePlan({opts, prompt, apiKey});
        planOut.textContent = (text && typeof text==='string') ? text : (LANG==='ar'?'ÿ™ÿπÿ∞ÿ± ÿ™ŸÅÿ≥Ÿäÿ± ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä.':'Could not parse AI response.');
      }catch(err){
        console.error(err);
        planOut.textContent = (LANG==='ar'?'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä.':'AI request failed.') + ' ' + (err?.message||'');
      }
    });

    // Save / Load Plans
    const PLANS_KEY='plans_v1';
    function loadPlans(){ return JSON.parse(localStorage.getItem(PLANS_KEY)||'[]'); }
    function savePlans(lst){ localStorage.setItem(PLANS_KEY, JSON.stringify(lst)); }
    function renderPlans(){
      const wrap=document.getElementById('plansList'); wrap.innerHTML='';
      const lst=loadPlans().sort((a,b)=>b.created-a.created);
      if(!lst.length){ wrap.innerHTML = `<div class="meta">${LANG==='ar'?'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆÿ∑ÿ∑ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ®ÿπÿØ.':'No saved plans yet.'}</div>`; return; }
      lst.forEach(p=>{
        const card=document.createElement('div'); card.className='card fadeIn';
        const content=document.createElement('div'); content.className='content';
        const title=document.createElement('div'); title.className='title';
        title.innerHTML=`<strong>${p.name}</strong>`;
        const meta=document.createElement('div'); meta.className='meta';
        meta.textContent = new Date(p.created).toLocaleString();
        const text=document.createElement('pre'); text.style.whiteSpace='pre-wrap'; text.textContent=p.text;
        const actions=document.createElement('div'); actions.className='actions';
        const copy=document.createElement('button'); copy.className='btn'; copy.innerHTML='<i class="fa-regular fa-copy"></i> Copy'; copy.onclick=()=>{ navigator.clipboard.writeText(p.text); };
        const del=document.createElement('button'); del.className='btn'; del.innerHTML='<i class="fa-regular fa-trash-can"></i> Delete'; del.onclick=()=>{ const all=loadPlans().filter(x=>x.id!==p.id); savePlans(all); renderPlans(); };
        actions.appendChild(copy); actions.appendChild(del);
        content.appendChild(title); content.appendChild(meta); content.appendChild(text); content.appendChild(actions);
        card.appendChild(content); wrap.appendChild(card);
      });
    }
    document.getElementById('savePlan').addEventListener('click', ()=>{
      const txt = planOut.textContent.trim();
      if(!txt){ alert(LANG==='ar'?'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆÿ∑ÿ© ŸÑÿ≠ŸÅÿ∏Ÿáÿß.':'Nothing to save.'); return; }
      const opts = getPlannerOptions();
      const id = Date.now().toString(36);
      const name = (LANG==='ar'?'ÿÆÿ∑ÿ© ':'Plan ') + `${opts.days}d-${opts.goal}`;
      const lst=loadPlans(); lst.push({id, name, text:txt, created:Date.now(), opts}); savePlans(lst); renderPlans();
      alert(LANG==='ar'?'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏.':'Saved.');
    });

    // PWA install
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt=e; document.getElementById('installBtn').style.display='inline-flex';
    });
    document.getElementById('installBtn').addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; deferredPrompt=null;
    });

    // Offline SW
    (function registerSW(){
      if(!('serviceWorker' in navigator)) return;
      const code = `
        const CACHE='stp-v1';
        self.addEventListener('install', e=>{ self.skipWaiting(); });
        self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener('message', e=>{ if(e.data&&e.data.type==='CACHE_URLS'){ caches.open(CACHE).then(c=>c.addAll(e.data.urls)); } });
        self.addEventListener('fetch', e=>{
          const req=e.request;
          if(req.method!=='GET') return;
          if(req.mode==='navigate'){
            e.respondWith(fetch(req).then(r=>{ const c=r.clone(); caches.open(CACHE).then(cc=>cc.put(req,c)); return r; }).catch(()=>caches.match(req)));
            return;
          }
          const url=new URL(req.url);
          if(url.origin===location.origin){
            e.respondWith(caches.match(req).then(hit=>hit||fetch(req).then(r=>{ const c=r.clone(); caches.open(CACHE).then(cc=>cc.put(req,c)); return r; }).catch(()=>hit)));
          }else{
            e.respondWith(fetch(req).catch(()=>caches.match(req)));
          }
        });
      `;
      const blob = new Blob([code], {type:'text/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob)).then(()=>{
        if(navigator.serviceWorker.controller){
          navigator.serviceWorker.controller.postMessage({type:'CACHE_URLS', urls:[location.href]});
        }else{
          navigator.serviceWorker.addEventListener('controllerchange', ()=>{
            if(navigator.serviceWorker.controller){
              navigator.serviceWorker.controller.postMessage({type:'CACHE_URLS', urls:[location.href]});
            }
          });
        }
      }).catch(console.warn);
    })();

    // Initial render
    applyTheme(); applyLang(); renderPlans();
  </script>

  <!-- Inline AI (Gemini): provides window.AI.generatePlan({opts, prompt, apiKey}) -->
  <script>
  (function(){
    function t(s){ return (document.documentElement.lang === 'ar') ? s.ar : s.en; }
    async function geminiCall(apiKey, systemText, userText, model){
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model || 'gemini-1.5-flash'}:generateContent`;
      const body = {
        systemInstruction: { role: "system", parts: [{ text: systemText }] },
        contents: [{ role: "user", parts: [{ text: userText }]}],
        generationConfig: { temperature: 0.7, maxOutputTokens: 1200 }
      };
      const r = await fetch(url + `?key=${encodeURIComponent(apiKey)}`, {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text().catch(()=>'');
        throw new Error(t({
          ar: "ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Gemini. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸàÿßŸÑÿ∑ÿ±ÿßÿ≤. ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: " + txt,
          en: "Failed calling Gemini. Check key/model. Details: " + txt
        }));
      }
      const j = await r.json();
      const parts = j?.candidates?.[0]?.content?.parts || [];
      const text = parts.map(p=>p.text||"").join("").trim();
      if(!text) throw new Error(t({ar:"ŸÑŸÖ ÿ£ÿ™ŸÑŸÇŸëŸé ŸÜÿµŸãÿß ŸÖŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨.", en:"No content returned by model."}));
      return text;
    }

    window.AI = window.AI || {};
    window.AI.generatePlan = async function({opts, prompt, apiKey}){
      if(!apiKey || typeof apiKey!=='string'){
        throw new Error(t({ar:"ŸÖÿ∑ŸÑŸàÿ® ŸÖŸÅÿ™ÿßÿ≠ Gemini API.", en:"Gemini API key is required."}));
      }
      const sys = t({
        ar: "ÿ£ŸÜÿ™ ŸÖÿØÿ±ÿ® ŸÑŸäÿßŸÇÿ© ŸäŸÉÿ™ÿ® ÿÆÿ∑ÿ∑Ÿãÿß Ÿàÿßÿ∂ÿ≠ÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸàÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©ÿå ŸÖŸÜÿ∏ŸÖÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸäÿßŸÖÿå ŸÖÿπ ŸÖÿ¨ŸÖŸàÿπÿßÿ™√óÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ÿå ÿ™ŸÖÿ®Ÿàÿå ÿ±ÿßÿ≠ÿ©ÿå ŸàŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ™ŸÇŸÜŸäÿ© ŸÇÿµŸäÿ±ÿ©. ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸÇÿßÿ∑Ÿãÿß ŸÖÿ±ÿ™ÿ®ÿ© Ÿàÿ≥ŸáŸÑÿ© ÿßŸÑŸÇÿ±ÿßÿ°ÿ©.",
        en: "You are a fitness coach producing clear, day-structured plans with sets√óreps, tempo, rest, and brief technique notes, bilingual (Arabic & English). Use tidy bullet lists."
      });
      return await geminiCall(apiKey, sys, prompt, "gemini-1.5-flash");
    };
  })();
  </script>
</body>
</html>
